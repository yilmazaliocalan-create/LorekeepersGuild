<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lorekeepers Guild - MasaÃ¼stÃ¼ YÃ¶neticisi</title>
    
    <!-- Tailwind CSS (TasarÄ±m iÃ§in) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome (Ä°konlar iÃ§in) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts (Estetik iÃ§in) -->
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* Koyu Arkaplan */
            color: #e5e7eb;
        }
        h1, h2, h3, button.fancy {
            font-family: 'Cinzel', serif;
        }
        .glass-panel {
            background: rgba(31, 41, 55, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .input-dark {
            background-color: #374151;
            border: 1px solid #4b5563;
            color: white;
            outline: none;
        }
        .input-dark:focus {
            border-color: #6366f1;
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.5);
        }
        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
    </style>
</head>
<body>

    <div id="app" class="min-h-screen flex flex-col">
        <!-- Dinamik Ä°Ã§erik Buraya Gelecek -->
        <div id="loading" class="flex items-center justify-center h-screen text-2xl text-indigo-400">
            <i class="fas fa-spinner fa-spin mr-3"></i> Lorekeepers Guild YÃ¼kleniyor...
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, addDoc, onSnapshot, query, orderBy, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

        // ============================================================
        // ðŸ”¥ BURAYI KENDÄ° FIREBASE BÄ°LGÄ°LERÄ°NÄ°ZLE GÃœNCELLEYÄ°N ðŸ”¥
        // ============================================================
        const firebaseConfig = {
            apiKey: "AIzaSy_YOUR_API_KEY",
            authDomain: "your-project.firebaseapp.com",
            projectId: "your-project-id",
            storageBucket: "your-project.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef"
        };
        // ============================================================

        // Firebase BaÅŸlatma
        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (error) {
            console.error("Firebase HatasÄ±:", error);
            document.getElementById('app').innerHTML = `
                <div class="flex items-center justify-center h-screen text-red-500 p-10 text-center">
                    <div>
                        <h1 class="text-3xl mb-4">YapÄ±landÄ±rma HatasÄ±</h1>
                        <p>LÃ¼tfen index.html dosyasÄ±nÄ± aÃ§Ä±n ve <b>firebaseConfig</b> bÃ¶lÃ¼mÃ¼ne kendi anahtarlarÄ±nÄ±zÄ± yapÄ±ÅŸtÄ±rÄ±n.</p>
                    </div>
                </div>`;
        }

        // --- STATE YÃ–NETÄ°MÄ° ---
        const state = {
            user: null,      // Firebase User
            username: localStorage.getItem('lkg_username') || '', 
            view: 'login',   // login, menu, char-creator, table
            characters: [],  // KullanÄ±cÄ±nÄ±n karakterleri
            activeTable: null, // Åžu anki masa verisi
            activeCharId: null, // Masada seÃ§ili karakter ID
            chatMessages: []
        };

        // --- DOM ELEMENTLERÄ° ---
        const appDiv = document.getElementById('app');

        // --- ANA RENDER FONKSÄ°YONU ---
        function render() {
            appDiv.innerHTML = ''; // Temizle

            if (state.view === 'login') {
                renderLogin();
            } else if (state.view === 'menu') {
                renderMenu();
            } else if (state.view === 'char-creator') {
                renderCharacterCreator();
            } else if (state.view === 'table') {
                renderGameTable();
            }
        }

        // --- 1. GÄ°RÄ°Åž EKRANI ---
        function renderLogin() {
            const container = document.createElement('div');
            container.className = "flex flex-col items-center justify-center min-h-screen bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]";
            
            container.innerHTML = `
                <div class="glass-panel p-10 rounded-2xl shadow-2xl text-center max-w-md w-full border-t-4 border-indigo-500">
                    <div class="text-6xl text-indigo-500 mb-4"><i class="fas fa-dragon"></i></div>
                    <h1 class="text-4xl font-bold text-white mb-2">LOREKEEPERS</h1>
                    <h2 class="text-xl text-indigo-300 mb-8 tracking-widest">GUILD</h2>
                    
                    <div class="space-y-4">
                        <label class="block text-left text-sm text-gray-400">MaceracÄ± AdÄ±</label>
                        <input type="text" id="usernameInput" value="${state.username}" class="w-full p-3 rounded-lg input-dark text-center text-lg font-bold" placeholder="Ä°sminizi girin...">
                        <button id="loginBtn" class="fancy w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-bold transition transform hover:scale-105 shadow-lg">
                            KAPIDAN GÄ°R
                        </button>
                    </div>
                </div>
            `;

            appDiv.appendChild(container);

            document.getElementById('loginBtn').onclick = async () => {
                const name = document.getElementById('usernameInput').value.trim();
                if (name) {
                    state.username = name;
                    localStorage.setItem('lkg_username', name);
                    await signInAnonymously(auth); // Firebase Anonim GiriÅŸ
                    // Auth listener state'i gÃ¼ncelleyip render edecek
                } else {
                    alert("LÃ¼tfen bir isim girin!");
                }
            };
        }

        // --- 2. ANA MENÃœ ---
        function renderMenu() {
            const container = document.createElement('div');
            container.className = "flex flex-col items-center min-h-screen p-6";
            
            container.innerHTML = `
                <header class="w-full max-w-4xl flex justify-between items-center mb-12 border-b border-gray-700 pb-4">
                    <div class="text-2xl font-bold text-indigo-400"><i class="fas fa-dungeon"></i> LKG</div>
                    <div class="text-gray-300">HoÅŸ geldin, <span class="font-bold text-white">${state.username}</span></div>
                </header>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-8 w-full max-w-5xl">
                    <!-- Kart 1: Karakter -->
                    <div class="glass-panel p-6 rounded-xl hover:bg-gray-800 transition cursor-pointer group" id="btnCreateChar">
                        <div class="text-4xl text-emerald-400 mb-4 group-hover:scale-110 transition"><i class="fas fa-user-shield"></i></div>
                        <h3 class="text-xl font-bold text-white mb-2">Karakter Yarat</h3>
                        <p class="text-gray-400 text-sm">Yeni bir kahraman oluÅŸtur veya mevcut karakterlerini dÃ¼zenle.</p>
                    </div>

                    <!-- Kart 2: Masa AÃ§ -->
                    <div class="glass-panel p-6 rounded-xl hover:bg-gray-800 transition cursor-pointer group" id="btnCreateGame">
                        <div class="text-4xl text-amber-400 mb-4 group-hover:scale-110 transition"><i class="fas fa-plus-circle"></i></div>
                        <h3 class="text-xl font-bold text-white mb-2">Masa AÃ§ (DM)</h3>
                        <p class="text-gray-400 text-sm">Dungeon Master olarak yeni bir oyun oturumu baÅŸlat.</p>
                    </div>

                    <!-- Kart 3: Masaya Otur -->
                    <div class="glass-panel p-6 rounded-xl hover:bg-gray-800 transition group">
                        <div class="text-4xl text-rose-400 mb-4 group-hover:scale-110 transition"><i class="fas fa-chair"></i></div>
                        <h3 class="text-xl font-bold text-white mb-2">Masaya Otur</h3>
                        <p class="text-gray-400 text-sm mb-4">DM'in verdiÄŸi kod ile oyuna katÄ±l.</p>
                        <div class="flex gap-2">
                            <input type="text" id="joinCodeInput" placeholder="KOD" class="w-full p-2 rounded input-dark uppercase text-center">
                            <button id="btnJoinGame" class="bg-rose-600 hover:bg-rose-700 text-white px-4 rounded font-bold">GÄ°R</button>
                        </div>
                    </div>
                </div>

                <!-- Alt KÄ±sÄ±m: Kaos ZarÄ± -->
                <div class="mt-12 w-full max-w-lg glass-panel p-6 rounded-xl border-t-4 border-purple-500">
                    <h3 class="text-lg font-bold text-purple-400 mb-4 text-center"><i class="fas fa-dice-d20"></i> Kaos ZarÄ±</h3>
                    <div class="flex gap-2 justify-center mb-4">
                        <input type="text" id="diceFormula" placeholder="Ã–rn: 1d20+5" class="w-full p-3 rounded input-dark font-mono text-lg">
                        <button id="btnRollDice" class="bg-purple-600 hover:bg-purple-700 text-white px-6 rounded font-bold">AT</button>
                    </div>
                    <div id="diceResult" class="text-center text-gray-400 text-sm min-h-[24px]"></div>
                </div>
            `;

            appDiv.appendChild(container);

            // Event Listeners
            document.getElementById('btnCreateChar').onclick = () => { state.view = 'char-creator'; render(); };
            
            document.getElementById('btnCreateGame').onclick = async () => {
                const code = Math.random().toString(36).substring(2, 7).toUpperCase();
                const newTable = {
                    code: code,
                    dmId: state.user.uid,
                    dmName: state.username,
                    createdAt: serverTimestamp(),
                    players: [] 
                };
                // Tabloyu oluÅŸtur
                await setDoc(doc(db, "tables", code), newTable);
                // Masaya gir
                state.activeTable = newTable;
                state.view = 'table';
                render();
            };

            document.getElementById('btnJoinGame').onclick = async () => {
                const code = document.getElementById('joinCodeInput').value.trim().toUpperCase();
                if(!code) return;
                // Tablo var mÄ± kontrol etmeye gerek yok, snapshot dinleyicisi halledecek
                state.activeTable = { code: code }; // GeÃ§ici
                state.view = 'table';
                render();
            };

            // Dice Logic
            document.getElementById('btnRollDice').onclick = () => {
                const formula = document.getElementById('diceFormula').value;
                const res = rollDice(formula);
                const resDiv = document.getElementById('diceResult');
                if (res.error) {
                    resDiv.innerHTML = `<span class="text-red-400">${res.error}</span>`;
                } else {
                    resDiv.innerHTML = `<span class="text-white font-bold text-xl">${res.total}</span> <span class="text-gray-500">(${res.details})</span>`;
                }
            };
        }

        // --- 3. KARAKTER YARATICI ---
        function renderCharacterCreator() {
            const container = document.createElement('div');
            container.className = "p-6 max-w-4xl mx-auto w-full";
            
            // Ã–rnek karakter verisi yoksa boÅŸ baÅŸlat
            let charData = { name: '', race: '', class: '', str: 10, dex: 10, con: 10, int: 10, wis: 10, cha: 10, notes: '' };

            container.innerHTML = `
                <button id="backBtn" class="mb-4 text-gray-400 hover:text-white"><i class="fas fa-arrow-left"></i> Geri DÃ¶n</button>
                <div class="glass-panel p-8 rounded-xl shadow-2xl border border-gray-700">
                    <h2 class="text-3xl font-bold text-white mb-6 border-b border-gray-600 pb-4">Karakter KaÄŸÄ±dÄ±</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div><label class="text-xs text-gray-500">Karakter AdÄ±</label><input type="text" id="c_name" class="w-full p-2 rounded input-dark"></div>
                        <div><label class="text-xs text-gray-500">Irk</label><input type="text" id="c_race" class="w-full p-2 rounded input-dark"></div>
                        <div><label class="text-xs text-gray-500">SÄ±nÄ±f & Seviye</label><input type="text" id="c_class" class="w-full p-2 rounded input-dark"></div>
                    </div>

                    <div class="grid grid-cols-6 gap-2 mb-6 text-center">
                        ${['STR', 'DEX', 'CON', 'INT', 'WIS', 'CHA'].map(stat => `
                            <div class="bg-gray-800 p-2 rounded border border-gray-600">
                                <label class="block text-xs font-bold text-indigo-400 mb-1">${stat}</label>
                                <input type="number" id="c_${stat.toLowerCase()}" value="10" class="w-full bg-transparent text-center text-white font-bold text-xl outline-none">
                            </div>
                        `).join('')}
                    </div>

                    <div class="mb-6">
                        <label class="text-xs text-gray-500">Notlar & Envanter</label>
                        <textarea id="c_notes" class="w-full p-3 rounded input-dark h-32"></textarea>
                    </div>

                    <div class="flex gap-4">
                        <button id="saveCharBtn" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-3 rounded font-bold">Karakteri Kaydet</button>
                        <button id="downloadPdfBtn" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white py-3 rounded font-bold"><i class="fas fa-file-pdf"></i> PDF Ä°ndir</button>
                    </div>
                </div>

                <div class="mt-8">
                    <h3 class="text-xl text-white mb-4">Karakterlerim</h3>
                    <div id="charList" class="grid gap-4 grid-cols-1 md:grid-cols-2">
                        <!-- Karakter Listesi Buraya Gelecek -->
                    </div>
                </div>
            `;

            appDiv.appendChild(container);

            // Listener'lar
            document.getElementById('backBtn').onclick = () => { state.view = 'menu'; render(); };
            
            // Karakterleri Getir
            const charCollection = collection(db, `users/${state.user.uid}/characters`);
            onSnapshot(charCollection, (snapshot) => {
                const listDiv = document.getElementById('charList');
                listDiv.innerHTML = '';
                snapshot.forEach(doc => {
                    const c = doc.data();
                    const item = document.createElement('div');
                    item.className = "bg-gray-800 p-4 rounded border border-gray-700 flex justify-between items-center";
                    item.innerHTML = `<div><div class="font-bold text-white">${c.name}</div><div class="text-xs text-gray-400">${c.race} ${c.class}</div></div>`;
                    listDiv.appendChild(item);
                });
            });

            document.getElementById('saveCharBtn').onclick = async () => {
                const data = {
                    name: document.getElementById('c_name').value,
                    race: document.getElementById('c_race').value,
                    class: document.getElementById('c_class').value,
                    str: document.getElementById('c_str').value,
                    dex: document.getElementById('c_dex').value,
                    con: document.getElementById('c_con').value,
                    int: document.getElementById('c_int').value,
                    wis: document.getElementById('c_wis').value,
                    cha: document.getElementById('c_cha').value,
                    notes: document.getElementById('c_notes').value,
                    createdAt: serverTimestamp()
                };
                if (!data.name) return alert("Ä°sim gerekli!");
                await addDoc(charCollection, data);
                alert("Karakter Kaydedildi!");
            };

             document.getElementById('downloadPdfBtn').onclick = () => {
                 window.print(); // Basit PDF Ã§Ã¶zÃ¼mÃ¼
             };
        }

        // --- 4. OYUN MASASI (Lobi) ---
        function renderGameTable() {
            const tableId = state.activeTable.code;
            const container = document.createElement('div');
            container.className = "flex flex-col h-screen";
            
            container.innerHTML = `
                <!-- Ãœst Bar -->
                <div class="bg-gray-800 p-4 shadow flex justify-between items-center border-b border-gray-700">
                    <div class="flex items-center gap-4">
                        <button id="leaveTableBtn" class="text-gray-400 hover:text-white"><i class="fas fa-arrow-left"></i> Ã‡Ä±k</button>
                        <h2 class="text-xl font-bold text-indigo-400">Masa: <span class="font-mono text-white bg-gray-700 px-2 py-1 rounded select-all">${tableId}</span></h2>
                    </div>
                    <div class="text-sm text-gray-400">DM: <span id="dmNameDisplay">YÃ¼kleniyor...</span></div>
                </div>

                <div class="flex flex-1 overflow-hidden">
                    <!-- Sol: Oyuncular ve Karakter SeÃ§imi -->
                    <div class="w-1/4 bg-gray-900 p-4 border-r border-gray-700 flex flex-col overflow-y-auto">
                        
                        <div class="mb-6">
                            <h3 class="text-xs font-bold text-gray-500 uppercase mb-2">Karakterini SeÃ§</h3>
                            <select id="charSelect" class="w-full p-2 rounded input-dark text-sm">
                                <option value="">-- SeÃ§iniz --</option>
                            </select>
                            <button id="btnPickChar" class="w-full mt-2 bg-green-700 hover:bg-green-600 text-white py-1 rounded text-sm">Masaya Koy</button>
                        </div>

                        <h3 class="text-xs font-bold text-gray-500 uppercase mb-2">Oyuncular</h3>
                        <div id="playerList" class="space-y-2">
                            <!-- Oyuncu Listesi -->
                        </div>
                    </div>

                    <!-- Orta: Sohbet -->
                    <div class="flex-1 flex flex-col bg-gray-800">
                        <div id="chatArea" class="flex-1 overflow-y-auto p-4 space-y-3">
                            <!-- Mesajlar -->
                        </div>
                        <div class="p-4 bg-gray-900 border-t border-gray-700 flex gap-2">
                            <input type="text" id="chatInput" placeholder="Mesaj yaz..." class="flex-1 p-3 rounded-lg input-dark">
                            <button id="btnSendChat" class="bg-indigo-600 hover:bg-indigo-700 px-6 rounded-lg text-white font-bold"><i class="fas fa-paper-plane"></i></button>
                        </div>
                    </div>
                
                    <!-- SaÄŸ: Zar ve AraÃ§lar -->
                    <div class="w-1/4 bg-gray-900 p-4 border-l border-gray-700">
                         <h3 class="text-xs font-bold text-gray-500 uppercase mb-2">Kaos ZarÄ±</h3>
                         <div class="flex gap-2 mb-2">
                            <input type="text" id="tableDiceInput" placeholder="1d20" class="w-full p-2 rounded input-dark">
                            <button id="btnTableRoll" class="bg-purple-600 text-white px-4 rounded">AT</button>
                         </div>
                         <div class="text-xs text-gray-400 mb-4">Zar sonuÃ§larÄ± sohbete gÃ¶nderilir.</div>
                    </div>
                </div>
            `;

            appDiv.appendChild(container);

            // Listener'lar
            document.getElementById('leaveTableBtn').onclick = () => { state.view = 'menu'; render(); };

            // MasayÄ± Dinle
            const tableRef = doc(db, "tables", tableId);
            
            // 1. Masa Bilgisi
            onSnapshot(tableRef, (doc) => {
                if (!doc.exists()) { alert("Masa kapandÄ±!"); state.view='menu'; render(); return; }
                const data = doc.data();
                document.getElementById('dmNameDisplay').textContent = data.dmName;
                
                // Oyuncu listesini gÃ¼ncelle
                const pList = document.getElementById('playerList');
                pList.innerHTML = '';
                if (data.players) {
                    data.players.forEach(p => {
                        pList.innerHTML += `
                            <div class="bg-gray-800 p-2 rounded flex justify-between items-center">
                                <div>
                                    <div class="font-bold text-white text-sm">${p.name}</div>
                                    <div class="text-xs text-indigo-400">${p.charName || 'Karaktersiz'}</div>
                                </div>
                                ${p.id === state.user.uid ? '<span class="text-xs text-green-500">(Sen)</span>' : ''}
                            </div>`;
                    });
                }
            });

            // 2. Sohbeti Dinle
            const chatRef = collection(db, `tables/${tableId}/chat`);
            const q = query(chatRef, orderBy("createdAt"));
            onSnapshot(q, (snapshot) => {
                const chatArea = document.getElementById('chatArea');
                chatArea.innerHTML = '';
                snapshot.forEach(doc => {
                    const msg = doc.data();
                    const isMe = msg.uid === state.user.uid;
                    const isRoll = msg.type === 'roll';
                    
                    chatArea.innerHTML += `
                        <div class="flex ${isMe ? 'justify-end' : 'justify-start'}">
                            <div class="max-w-[80%] p-3 rounded-lg ${isMe ? 'bg-indigo-600 text-white rounded-br-none' : 'bg-gray-700 text-gray-200 rounded-tl-none'} ${isRoll ? 'border border-purple-500 bg-gray-800' : ''}">
                                <div class="text-xs font-bold opacity-75 mb-1">${msg.name}</div>
                                <div class="${isRoll ? 'text-lg font-mono font-bold text-purple-300' : ''}">${msg.text}</div>
                            </div>
                        </div>
                    `;
                });
                chatArea.scrollTop = chatArea.scrollHeight;
            });

            // 3. Karakter Listesini Doldur (Dropdown)
            const charCol = collection(db, `users/${state.user.uid}/characters`);
            onSnapshot(charCol, (snapshot) => {
                const select = document.getElementById('charSelect');
                snapshot.forEach(doc => {
                    const c = doc.data();
                    const opt = document.createElement('option');
                    opt.value = doc.id;
                    opt.text = c.name;
                    // Karakter verisini option dataset'e ekle
                    opt.dataset.name = c.name;
                    select.appendChild(opt);
                });
            });

            // Aksiyonlar
            document.getElementById('btnPickChar').onclick = async () => {
                const select = document.getElementById('charSelect');
                const charId = select.value;
                const charName = select.options[select.selectedIndex].dataset.name;
                
                if (!charId) return;

                // Masaya oyuncu olarak kendini ekle/gÃ¼ncelle
                // Not: GerÃ§ek projede bu arrayUnion/arrayRemove ile daha temiz yapÄ±lÄ±r, burada basit update kullanÄ±yoruz.
                // Mevcut oyuncu listesini alÄ±p kendimizi gÃ¼ncelleyeceÄŸiz.
                const tDoc = await import("https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js").then(m=>m.getDoc(tableRef));
                let players = tDoc.data().players || [];
                
                // Kendini bul ve gÃ¼ncelle veya ekle
                const idx = players.findIndex(p => p.id === state.user.uid);
                if (idx > -1) {
                    players[idx].charName = charName;
                    players[idx].charId = charId;
                } else {
                    players.push({ id: state.user.uid, name: state.username, charId, charName });
                }
                
                await updateDoc(tableRef, { players });
            };

            document.getElementById('btnSendChat').onclick = async () => {
                const txt = document.getElementById('chatInput').value.trim();
                if (!txt) return;
                await addDoc(chatRef, {
                    text: txt,
                    name: state.username,
                    uid: state.user.uid,
                    createdAt: serverTimestamp(),
                    type: 'msg'
                });
                document.getElementById('chatInput').value = '';
            };

            document.getElementById('btnTableRoll').onclick = async () => {
                 const formula = document.getElementById('tableDiceInput').value;
                 const res = rollDice(formula);
                 if (!res.error) {
                     await addDoc(chatRef, {
                        text: `ðŸŽ² ${formula}: ${res.total} (${res.details})`,
                        name: state.username,
                        uid: state.user.uid,
                        createdAt: serverTimestamp(),
                        type: 'roll'
                    });
                 }
            };
        }

        // --- UTILS ---
        function rollDice(input) {
            try {
                // Basit parser: 2d20+5
                const parts = input.toLowerCase().split('d');
                if (parts.length !== 2) return { error: "GeÃ§ersiz format (Ã–rn: 1d20)" };
                
                let count = parseInt(parts[0]) || 1;
                let rest = parts[1].split('+');
                let faces = parseInt(rest[0]);
                let mod = rest.length > 1 ? parseInt(rest[1]) : 0;

                let total = 0;
                let rolls = [];
                for(let i=0; i<count; i++) {
                    let r = Math.floor(Math.random() * faces) + 1;
                    rolls.push(r);
                    total += r;
                }
                total += mod;
                return { total, details: `${rolls.join('+')} + ${mod}` };
            } catch (e) {
                return { error: "Hata" };
            }
        }

        // --- BAÅžLANGIÃ‡ ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                state.user = user;
                // EÄŸer kullanÄ±cÄ± adÄ± varsa menÃ¼ye, yoksa logine (gerÃ§i anonim giriÅŸi loginde yapÄ±yoruz)
                if (state.username) {
                    state.view = 'menu';
                } else {
                    state.view = 'login';
                }
            } else {
                state.view = 'login';
            }
            render();
        });

    </script>
</body>
</html>
