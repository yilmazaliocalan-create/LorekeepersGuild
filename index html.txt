<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lorekeepers Guild V33 (D&D 5e Sheet)</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Lato:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Mrs+Eaves+XL+Serif&display=swap" rel="stylesheet"> <!-- D&D benzeri font -->
    
    <style>
        /* --- Temel Stiller --- */
        :root {
            --color-bg: #f0f0f0; 
            --color-paper: #fdfbf7;
            --color-text: #222;
            --color-gold: #c6a235; 
            --color-red: #8a2be2; /* Accent rengi */
            --color-border: #ccc;
        }

        body {
            font-family: 'Lato', sans-serif;
            background-color: var(--color-bg); 
            color: var(--color-text);
            min-height: 100vh;
            margin: 0;
            display: flex;
            justify-content: center;
        }

        /* Konteyner */
        #app-container { width: 100%; }
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
        }

        /* --- D&D 5e Karakter Kaƒüƒ±dƒ± Stilleri --- */
        .dnd-sheet {
            background-color: var(--color-paper);
            padding: 30px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            border: 1px solid #dcdcdc;
            font-family: 'Lato', sans-serif;
            color: #000;
        }

        /* Header B√∂l√ºm√º */
        .dnd-header {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            align-items: flex-end;
            border-bottom: 2px solid var(--color-gold);
            padding-bottom: 20px;
        }
        
        .char-name-box {
            flex: 1;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            background: white;
        }
        
        .header-grid {
            flex: 2;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            background: #fff;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 5px;
        }

        /* Input Stilleri (Altƒ± √áizili) */
        .dnd-input {
            width: 100%;
            border: none;
            border-bottom: 1px solid #555;
            background: transparent;
            padding: 5px;
            font-size: 1rem;
            font-weight: bold;
            color: #333;
        }
        .dnd-input:focus { outline: none; border-bottom: 2px solid var(--color-gold); }
        
        .dnd-label {
            font-size: 0.65rem;
            text-transform: uppercase;
            color: #777;
            font-weight: bold;
            letter-spacing: 0.5px;
        }

        /* 3 S√ºtunlu D√ºzen */
        .sheet-grid {
            display: grid;
            grid-template-columns: 100px 1fr 1fr; /* Sol s√ºtun dar (statlar), diƒüerleri geni≈ü */
            gap: 30px;
        }
        @media (max-width: 1024px) { .sheet-grid { grid-template-columns: 1fr; } }

        /* Ability Scores (Sol S√ºtun) */
        .ability-score {
            text-align: center;
            border: 2px solid #000;
            border-radius: 15px;
            margin-bottom: 15px;
            position: relative;
            background: white;
            width: 90px;
            height: 100px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.1);
        }
        .ability-label { font-weight: bold; font-size: 0.7rem; text-transform: uppercase; margin-top: -10px; }
        .ability-mod { font-size: 1.8rem; font-weight: 900; }
        .ability-val-circle {
            width: 40px; height: 25px;
            border: 1px solid #000;
            border-radius: 15px;
            background: white;
            position: absolute;
            bottom: -12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .ability-val-input {
            width: 30px; text-align: center; border: none; font-size: 0.9rem; font-weight: bold;
        }

        /* Skills & Saves */
        .skills-box {
            margin-top: 20px;
            border: 1px solid #000;
            border-radius: 10px;
            padding: 10px;
        }
        .skill-row {
            display: flex; align-items: center; gap: 5px; font-size: 0.8rem;
            border-bottom: 1px solid #eee; padding: 2px 0;
        }
        .prof-dot {
            width: 10px; height: 10px; border: 1px solid #000; border-radius: 50%; cursor: pointer;
        }
        .prof-dot.active { background: black; }
        
        /* Combat Stats (Orta S√ºtun) */
        .combat-header {
            display: flex; gap: 10px; justify-content: center; margin-bottom: 20px;
        }
        .combat-box {
            border: 2px solid #000;
            padding: 10px;
            text-align: center;
            width: 80px;
            height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        /* Shield Shape for AC */
        .ac-box {
            clip-path: polygon(50% 0%, 100% 20%, 100% 80%, 50% 100%, 0% 80%, 0% 20%);
            background: white;
        }
        .combat-val { font-size: 1.5rem; font-weight: 900; border: none; text-align: center; width: 100%; }
        
        .hp-box {
            border: 1px solid #000; border-radius: 10px; padding: 10px; margin-bottom: 20px;
        }

        /* Right Column */
        .trait-box {
            border: 1px solid #000;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 10px;
            min-height: 80px;
            background: #fff;
        }
        .trait-label {
            font-family: 'Cinzel';
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.8rem;
            border-bottom: 1px solid #ccc;
            margin-bottom: 5px;
        }
        .dnd-textarea {
            width: 100%; border: none; resize: vertical; background: transparent; font-family: 'Lato'; font-size: 0.9rem;
        }

        /* --- Diƒüer Stiller (Login, Home vb. V32'den) --- */
        /* (Kƒ±sa tutmak i√ßin √∂nceki stilleri miras alƒ±yoruz, buraya kopyalƒ±yorum) */
        .card { background: white; border: 1px solid #ddd; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .card-header { font-weight: bold; font-size: 18px; margin-bottom: 10px; border-bottom: 2px solid var(--color-gold); }
        .flex-row { display: flex; align-items: center; justify-content: space-between; }
        .btn-primary { background-color: var(--color-gold); color: white; padding: 10px 20px; border-radius: 5px; font-weight: bold; cursor: pointer; border: none; }
        .btn-secondary { background: white; border: 1px solid #ccc; padding: 8px 15px; border-radius: 5px; cursor: pointer; }
        .dice-icon { font-size: 1.2em; margin-right: 5px; }
        .icon-gen { display: inline-block; font-size: 1.2em; vertical-align: middle; margin-right: 4px; }
        .dice-btn { background: #f8fafc; border: 2px solid #e2e8f0; padding: 10px; border-radius: 8px; cursor: pointer; display: flex; flex-direction: column; align-items: center; min-width: 60px; }
        .dice-btn:hover { border-color: var(--color-gold); }
        .formula-bar { background: #2c3e50; color: #f1c40f; padding: 10px; text-align: center; border-radius: 5px; font-family: monospace; margin: 10px 0; }

    </style>
</head>
<body>
    <div id="app-container"></div>

    <script>
        // --- CONFIG & STATE ---
        const KEYS = { CHARS: 'lk_chars_v33', CAMPAIGNS: 'lk_camps_v33', USER: 'lk_user_v33' };
        
        window.appState = {
            view: 'login',
            username: localStorage.getItem(KEYS.USER) || '',
            myCharacters: [],
            myCampaigns: [],
            activeChar: null,
            // Zar State
            pool: { 4:0, 6:0, 8:0, 10:0, 12:0, 20:0, 100:0 },
            rollResult: null,
            isRolling: false,
            builderTab: 'sheet'
        };

        // --- EMOJI ICONS ---
        const ICONS = {
            User: 'üë§', Map: 'üó∫Ô∏è', Plus: '‚ûï', LogOut: 'üö™', Edit: '‚úèÔ∏è', Trash: 'üóëÔ∏è', Save: 'üíæ', 
            X: '‚ùå', Home: 'üè∞', Copy: 'üìã', Check: '‚úÖ', Reset: 'üîÑ', Dices: 'üé≤', Settings: '‚öôÔ∏è',
            Dragon: 'üê≤'
        };
        const icon = (n) => `<span class="icon-gen">${ICONS[n] || ''}</span>`;

        // --- FANCY DICE SVGs ---
        const DICE_SVGS = {
            4:  `<path d="M12 2 L22 20 L2 20 Z" fill="#eab308" stroke="#713f12" stroke-width="1.5"/><text x="12" y="17" text-anchor="middle" fill="#422006" font-size="8" font-weight="bold">4</text>`,
            6:  `<rect x="4" y="4" width="16" height="16" rx="2" fill="#eab308" stroke="#713f12" stroke-width="1.5"/><text x="12" y="16" text-anchor="middle" fill="#422006" font-size="10" font-weight="bold">6</text>`,
            8:  `<path d="M12 2 L22 12 L12 22 L2 12 Z" fill="#eab308" stroke="#713f12" stroke-width="1.5"/><text x="12" y="16" text-anchor="middle" fill="#422006" font-size="8" font-weight="bold">8</text>`,
            10: `<path d="M12 2 L22 10 L12 22 L2 10 Z" fill="#eab308" stroke="#713f12" stroke-width="1.5"/><text x="12" y="15" text-anchor="middle" fill="#422006" font-size="8" font-weight="bold">10</text>`,
            12: `<path d="M12 2 L21 8 L18 19 L6 19 L3 8 Z" fill="#eab308" stroke="#713f12" stroke-width="1.5"/><text x="12" y="15" text-anchor="middle" fill="#422006" font-size="8" font-weight="bold">12</text>`,
            20: `<path d="M12 2 L21 7 L21 17 L12 22 L3 17 L3 7 Z" fill="#eab308" stroke="#713f12" stroke-width="1.5"/><text x="12" y="16" text-anchor="middle" fill="#422006" font-size="10" font-weight="bold">20</text>`,
            100:`<circle cx="12" cy="12" r="10" fill="#eab308" stroke="#713f12" stroke-width="1.5"/><text x="12" y="16" text-anchor="middle" fill="#422006" font-size="8" font-weight="bold">%</text>`
        };

        const SKILLS_LIST = [
          { name: 'Acrobatics', stat: 'dex' }, { name: 'Animal Handling', stat: 'wis' }, { name: 'Arcana', stat: 'int' },
          { name: 'Athletics', stat: 'str' }, { name: 'Deception', stat: 'cha' }, { name: 'History', stat: 'int' },
          { name: 'Insight', stat: 'wis' }, { name: 'Intimidation', stat: 'cha' }, { name: 'Investigation', stat: 'int' },
          { name: 'Medicine', stat: 'wis' }, { name: 'Nature', stat: 'int' }, { name: 'Perception', stat: 'wis' },
          { name: 'Performance', stat: 'cha' }, { name: 'Persuasion', stat: 'cha' }, { name: 'Religion', stat: 'int' },
          { name: 'Sleight of Hand', stat: 'dex' }, { name: 'Stealth', stat: 'dex' }, { name: 'Survival', stat: 'wis' },
        ];
        
        const SPELL_LEVELS = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9];

        // --- YARDIMCI FONKSƒ∞YONLAR ---
        const getMod = (score) => Math.floor(((score || 10) - 10) / 2);
        const formatMod = (score) => { const mod = getMod(score); return mod >= 0 ? `+${mod}` : `${mod}`; };
        const getProfBonus = (level) => Math.ceil((level || 1) / 4) + 1;
        const generateId = () => Date.now().toString(36) + Math.random().toString(36).substring(2);

        // --- DATA & LOGIC ---
        function loadData() {
            try {
                const chars = JSON.parse(localStorage.getItem(KEYS.CHARS) || '[]');
                const camps = JSON.parse(localStorage.getItem(KEYS.CAMPAIGNS) || '[]');
                window.appState.myCharacters = chars;
                window.appState.myCampaigns = camps;
                if (window.appState.username) setState({ view: 'home' });
            } catch (e) { console.error(e); }
        }

        function setState(newState) {
            window.appState = { ...window.appState, ...newState };
            render();
        }

        function saveData(key, data) {
            localStorage.setItem(key, JSON.stringify(data));
        }

        const createInitialCharData = (name = '') => ({
            id: generateId(),
            name: name, class: '', race: '', background: '', level: 1, xp: 0, alignment: '', playerName: window.appState.username,
            str: 10, dex: 10, con: 10, int: 10, wis: 10, cha: 10,
            hpMax: 10, hpCurrent: 10, ac: 10, speed: 30, init: 0, hitDice: '1d8',
            proficiencies: [], savingThrows: [],
            attacks: '', equipment: '', features: '', notes: '',
            personality: '', ideals: '', bonds: '', flaws: '',
            spellAbility: 'int', spellDC: 10, spellAttackMod: 2, 
            spellSlots: SPELL_LEVELS.reduce((acc, l) => ({ ...acc, [l]: { max: 0, current: 0 } }), {}),
            spells: SPELL_LEVELS.reduce((acc, l) => ({ ...acc, [l]: '' }), {}),
        });

        // --- RENDER ---
        function render() {
            const app = document.getElementById('app-container');
            const { view } = window.appState;
            
            if (view === 'login') app.innerHTML = renderLogin();
            else if (view === 'home') app.innerHTML = renderHome();
            else if (view === 'builder') app.innerHTML = renderBuilder();
            else if (view === 'table') app.innerHTML = renderTable();
            else if (view === 'profile') app.innerHTML = renderProfile();
            
            attachEvents();
        }

        // ... Login, Home, Table, Profile fonksiyonlarƒ± (√ñnceki versiyonla aynƒ±, yer kazanmak i√ßin kƒ±sa ge√ßiyorum) ...
        // Tam kodda bunlar V32'deki gibi olacaktƒ±r.
        function renderLogin() {
            return `<div style="height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;"><div style="font-size:5rem;margin-bottom:20px;">üê≤</div><h1>LOREKEEPERS</h1><div class="card"><input id="login-name" type="text" placeholder="Adƒ±n..." style="text-align:center;width:100%;padding:10px;"><button data-action="login" class="btn-primary" style="width:100%;margin-top:10px;">Giri≈ü</button></div></div>`;
        }
        function renderHome() {
            const { username, myCharacters } = window.appState;
            return `<div class="main-container"><div class="flex-row" style="margin-bottom:20px;"><h2>Ho≈ü Geldin, ${username}</h2><div style="display:flex;gap:10px;"><button data-action="goTable" class="btn-secondary">Masa</button><button data-action="goProfile" class="btn-secondary">Profil</button></div></div><div class="card"><h3>Karakterler</h3><button data-action="newChar" class="btn-primary" style="margin-bottom:10px;">+ Yeni Karakter</button>${myCharacters.map(c => `<div style="padding:10px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;"><span>${c.name} (Lvl ${c.level} ${c.class})</span><div><button data-action="editChar" data-id="${c.id}">‚úèÔ∏è</button><button data-action="delChar" data-id="${c.id}" style="color:red;">üóëÔ∏è</button></div></div>`).join('')}</div>${renderDiceRoller()}</div>`;
        }
        function renderDiceRoller() {
             const { pool, rollResult } = window.appState;
             const parts = []; Object.keys(pool).forEach(k => { if(pool[k]>0) parts.push(`${pool[k]}d${k}`); });
             const formula = parts.length ? parts.join(' + ') : 'Zar Se√ß...';
             return `<div class="card" style="border-top:4px solid #3b82f6;"><h3>üé≤ Kaotik Zar</h3><div class="formula-bar">${formula}</div><div style="display:grid;grid-template-columns:repeat(7,1fr);gap:5px;">${[4,6,8,10,12,20,100].map(d => `<div data-action="addDie" data-sides="${d}" class="dice-btn" style="cursor:pointer;text-align:center;"><svg style="width:40px;height:40px" viewBox="0 0 24 24">${DICE_SVGS[d]}</svg><div>D${d}</div></div>`).join('')}</div><div style="display:flex;gap:10px;margin-top:10px;"><button data-action="resetPool" class="btn-secondary" style="flex:1;">Sƒ±fƒ±rla</button><button data-action="roll" class="btn-primary" style="flex:2;">AT!</button></div>${rollResult ? `<div style="text-align:center;font-size:2rem;font-weight:bold;margin-top:10px;">${rollResult.total}</div>` : ''}</div>`;
        }
        function renderTable() { return `<div class="main-container"><button data-action="goHome" class="btn-secondary">Geri</button><h3>Masalar</h3><div class="card"><button data-action="createTable" class="btn-primary">Masa Kur</button></div>${window.appState.myCampaigns.map(c => `<div class="card">${c.name} (Kod: ${c.code})</div>`).join('')}</div>`; }
        function renderProfile() { const { username } = window.appState; return `<div class="main-container"><button data-action="goHome" class="btn-secondary">Geri</button><div class="card"><h3>Profil</h3><input id="p-username" value="${username}"><button data-action="saveProfile" class="btn-primary">Kaydet</button><button data-action="logout" style="color:red;margin-top:10px;">√áƒ±kƒ±≈ü</button></div></div>`; }

        // --- YENƒ∞ KARAKTER OLU≈ûTURUCU (D&D 5E STƒ∞Lƒ∞) ---
        function renderBuilder() {
            const c = window.appState.activeChar;
            const profBonus = getProfBonus(c.level);
            
            // Yetenek ve Skill Helper
            const getSkillMod = (skillName) => {
                const skill = SKILLS_LIST.find(s => s.name === skillName);
                const mod = getMod(c[skill.stat]);
                const prof = c.proficiencies?.includes(skill.name) ? profBonus : 0;
                const total = mod + prof;
                return total >= 0 ? `+${total}` : total;
            };

            return `
                <div class="main-container">
                    <div class="flex-row" style="margin-bottom:20px; position:sticky; top:0; background:var(--color-bg); z-index:10; padding:10px 0;">
                        <button data-action="goHome" class="btn-secondary">‚Üê ƒ∞ptal</button>
                        <h2 style="font-family:'Cinzel';margin:0;">${c.name || 'Karakter'}</h2>
                        <button data-action="saveChar" class="btn-primary">üíæ Kaydet</button>
                    </div>

                    <div class="dnd-sheet">
                        <!-- HEADER -->
                        <div class="dnd-header">
                            <div class="char-name-box">
                                <input data-field="name" type="text" class="dnd-input" style="font-size:1.5rem;" value="${c.name}" placeholder="Karakter Adƒ±">
                            </div>
                            <div class="header-grid">
                                <div><input data-field="class" type="text" class="dnd-input" value="${c.class}"><div class="dnd-label">Class & Level</div></div>
                                <div><input data-field="background" type="text" class="dnd-input" value="${c.background}"><div class="dnd-label">Background</div></div>
                                <div><input data-field="playerName" type="text" class="dnd-input" value="${c.playerName}"><div class="dnd-label">Player Name</div></div>
                                <div><input data-field="race" type="text" class="dnd-input" value="${c.race}"><div class="dnd-label">Race</div></div>
                                <div><input data-field="alignment" type="text" class="dnd-input" value="${c.alignment}"><div class="dnd-label">Alignment</div></div>
                                <div><input data-field="xp" type="number" class="dnd-input" value="${c.xp}"><div class="dnd-label">XP</div></div>
                                <div><input data-field="level" type="number" class="dnd-input" value="${c.level}"><div class="dnd-label">Level</div></div>
                            </div>
                        </div>

                        <!-- MAIN BODY -->
                        <div class="sheet-grid">
                            
                            <!-- COL 1: STATS & SKILLS -->
                            <div>
                                <!-- Ability Scores -->
                                ${['str','dex','con','int','wis','cha'].map(stat => `
                                    <div class="ability-score">
                                        <div class="ability-label">${stat}</div>
                                        <div class="ability-mod">${formatMod(c[stat])}</div>
                                        <div class="ability-val-circle">
                                            <input type="number" data-field="${stat}" value="${c[stat]}" class="ability-val-input">
                                        </div>
                                    </div>
                                `).join('')}

                                <!-- Proficiencies -->
                                <div class="skills-box">
                                    <div style="font-weight:bold;text-align:center;border-bottom:1px solid #000;margin-bottom:5px;">Inspiration & Prof</div>
                                    <div style="display:flex;align-items:center;gap:5px;margin-bottom:5px;">
                                        <div style="border:1px solid #000;border-radius:50%;width:30px;height:30px;display:flex;align-items:center;justify-content:center;font-weight:bold;">+${profBonus}</div>
                                        <span style="font-size:0.8rem;">Proficiency Bonus</span>
                                    </div>
                                    <hr>
                                    <!-- Saving Throws -->
                                    <div style="margin-top:5px;"><strong>Saving Throws</strong></div>
                                    ${['str','dex','con','int','wis','cha'].map(stat => {
                                        const isSave = c.savingThrows?.includes(stat);
                                        const mod = getMod(c[stat]) + (isSave ? profBonus : 0);
                                        return `
                                            <div class="skill-row" data-action="toggleSave" data-stat="${stat}">
                                                <div class="prof-dot ${isSave ? 'active' : ''}"></div>
                                                <span style="width:20px;text-align:center;">${mod>=0?'+'+mod:mod}</span>
                                                <span style="text-transform:uppercase;font-weight:bold;font-size:0.7rem;">${stat}</span>
                                            </div>
                                        `;
                                    }).join('')}
                                    
                                    <!-- Skills -->
                                    <div style="margin-top:10px;"><strong>Skills</strong></div>
                                    ${SKILLS_LIST.map(skill => `
                                        <div class="skill-row" data-action="toggleSkill" data-skill="${skill.name}">
                                            <div class="prof-dot ${c.proficiencies?.includes(skill.name) ? 'active' : ''}"></div>
                                            <span style="width:25px;text-align:center;">${getSkillMod(skill.name)}</span>
                                            <span>${skill.name} <span style="color:#888;font-size:0.6rem;">(${skill.stat})</span></span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>

                            <!-- COL 2: COMBAT -->
                            <div>
                                <div class="combat-header">
                                    <div class="combat-box ac-box">
                                        <input type="number" data-field="ac" value="${c.ac}" class="combat-val">
                                        <div class="dnd-label">Armor Class</div>
                                    </div>
                                    <div class="combat-box">
                                        <input type="number" data-field="init" value="${c.init || getMod(c.dex)}" class="combat-val">
                                        <div class="dnd-label">Initiative</div>
                                    </div>
                                    <div class="combat-box">
                                        <input type="number" data-field="speed" value="${c.speed}" class="combat-val">
                                        <div class="dnd-label">Speed</div>
                                    </div>
                                </div>

                                <div class="hp-box">
                                    <div style="display:flex;justify-content:space-between;font-size:0.7rem;color:#666;margin-bottom:5px;">
                                        <span>Hit Point Maximum: <input type="number" data-field="hpMax" value="${c.hpMax}" style="width:40px;border:none;border-bottom:1px solid #ccc;"></span>
                                    </div>
                                    <input type="number" data-field="hpCurrent" value="${c.hpCurrent}" style="width:100%;font-size:2rem;text-align:center;border:none;" placeholder="Current HP">
                                    <div style="text-align:center;font-weight:bold;font-size:0.8rem;">Current Hit Points</div>
                                </div>

                                <div style="display:flex;gap:10px;margin-bottom:20px;">
                                    <div class="hp-box" style="flex:1;">
                                        <div class="dnd-label">Hit Dice</div>
                                        <input type="text" data-field="hitDice" value="${c.hitDice}" style="width:100%;text-align:center;border:none;">
                                    </div>
                                    <div class="hp-box" style="flex:1;">
                                        <div class="dnd-label">Death Saves</div>
                                        <div style="font-size:0.7rem;">Success: ‚ñ° ‚ñ° ‚ñ°</div>
                                        <div style="font-size:0.7rem;">Failures: ‚ñ° ‚ñ° ‚ñ°</div>
                                    </div>
                                </div>

                                <div class="hp-box" style="min-height:200px;">
                                    <div class="dnd-label" style="margin-bottom:5px;">Attacks & Spellcasting</div>
                                    <textarea data-field="attacks" class="dnd-textarea" style="height:180px;">${c.attacks}</textarea>
                                </div>
                            </div>

                            <!-- COL 3: FEATURES -->
                            <div>
                                <div class="trait-box">
                                    <div class="trait-label">Personality Traits</div>
                                    <textarea data-field="personality" class="dnd-textarea">${c.personality}</textarea>
                                </div>
                                <div class="trait-box">
                                    <div class="trait-label">Ideals</div>
                                    <textarea data-field="ideals" class="dnd-textarea">${c.ideals}</textarea>
                                </div>
                                <div class="trait-box">
                                    <div class="trait-label">Bonds</div>
                                    <textarea data-field="bonds" class="dnd-textarea">${c.bonds}</textarea>
                                </div>
                                <div class="trait-box">
                                    <div class="trait-label">Flaws</div>
                                    <textarea data-field="flaws" class="dnd-textarea">${c.flaws}</textarea>
                                </div>
                                
                                <div class="trait-box" style="min-height:200px;">
                                    <div class="trait-label">Features & Traits</div>
                                    <textarea data-field="features" class="dnd-textarea" style="height:180px;">${c.features}</textarea>
                                </div>

                                <div class="trait-box" style="min-height:200px;">
                                    <div class="trait-label">Equipment</div>
                                    <textarea data-field="equipment" class="dnd-textarea" style="height:180px;">${c.equipment}</textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // --- EVENTS ---
        function handleEvent(e) {
            const t = e.target.closest('[data-action]');
            if (!t) return;
            const action = t.dataset.action;
            const id = t.dataset.id;

            if (action === 'login') {
                const name = document.getElementById('login-name').value;
                if(name) { localStorage.setItem(KEYS.USER, name); setState({ username: name, view: 'home' }); }
            }
            else if (action === 'goHome') setState({ view: 'home' });
            else if (action === 'goProfile') setState({ view: 'profile' });
            else if (action === 'goTable') setState({ view: 'table' });
            else if (action === 'newChar') setState({ activeChar: createInitialCharData('Yeni'), view: 'builder' });
            else if (action === 'editChar') setState({ activeChar: window.appState.myCharacters.find(c => c.id === id), view: 'builder' });
            else if (action === 'saveChar') {
                const char = window.appState.activeChar;
                const list = window.appState.myCharacters.filter(c => c.id !== char.id);
                list.push(char);
                saveData(KEYS.CHARS, list);
                setState({ myCharacters: list, view: 'home' });
            }
            else if (action === 'delChar') {
                if(confirm('Sil?')) {
                    const list = window.appState.myCharacters.filter(c => c.id !== id);
                    saveData(KEYS.CHARS, list);
                    setState({ myCharacters: list });
                }
            }
            // ... (Other handlers like dice roll, etc. same as before)
            else if (action === 'roll') rollDice();
            else if (action === 'resetPool') resetPool();
            else if (action === 'addDie') addDie(t.dataset.sides);
            else if (action === 'saveProfile') {
                const n = document.getElementById('p-username').value;
                localStorage.setItem(KEYS.USER, n);
                setState({username: n, view: 'home'});
            }
            else if (action === 'logout') {
                localStorage.removeItem(KEYS.USER);
                setState({username: '', view: 'login'});
            }
            else if (action === 'toggleSkill') {
                const skill = t.dataset.skill;
                const char = window.appState.activeChar;
                const profs = char.proficiencies || [];
                if (profs.includes(skill)) char.proficiencies = profs.filter(p => p !== skill);
                else char.proficiencies = [...profs, skill];
                setState({ activeChar: char });
            }
            else if (action === 'toggleSave') {
                const stat = t.dataset.stat;
                const char = window.appState.activeChar;
                const saves = char.savingThrows || [];
                if (saves.includes(stat)) char.savingThrows = saves.filter(s => s !== stat);
                else char.savingThrows = [...saves, stat];
                setState({ activeChar: char });
            }
        }
        
        // Handle Input changes
        function handleInput(e) {
            const field = e.target.dataset.field;
            if (field && window.appState.activeChar) {
                const val = e.target.type === 'number' ? parseInt(e.target.value) || 0 : e.target.value;
                window.appState.activeChar[field] = val;
                // Re-render only if stats change to update mods instantly
                if(['str','dex','con','int','wis','cha','level'].includes(field)) render(); 
            }
        }
        
        // Zar fonksiyonlarƒ± (Kƒ±saltƒ±ldƒ±, aynƒ± mantƒ±k)
        function addDie(s) { const p=window.appState.pool; p[s]++; setState({pool:p}); }
        function resetPool() { setState({pool:{4:0,6:0,8:0,10:0,12:0,20:0,100:0}, rollResult:null}); }
        function rollDice() {
             setState({isRolling:true});
             setTimeout(() => {
                 let total=0, details=[];
                 const pool = window.appState.pool;
                 Object.keys(pool).forEach(s => {
                     if(pool[s]>0) {
                         const rolls=[];
                         for(let i=0;i<pool[s];i++) {
                             const r=Math.floor(Math.random()*s)+1;
                             rolls.push(r); total+=r;
                         }
                         details.push({type:'d'+s, rolls});
                     }
                 });
                 setState({isRolling:false, rollResult:{total, details}, pool:{4:0,6:0,8:0,10:0,12:0,20:0,100:0}});
             }, 600);
        }

        function attachEvents() {
            document.body.onclick = handleEvent;
            document.body.oninput = handleInput;
        }

        window.onload = () => { loadData(); render(); };
    </script>
</body>
</html>